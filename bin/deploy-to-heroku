#!/bin/bash
ROOT="$(dirname "$0")/.."
source "$ROOT/bin/_util"

set -e

cd "$ROOT"

PROGRAM=`basename $0`

usage() {
  cat >&2 <<STR
usage: $PROGRAM [ --app <app_name> ]

Builds docker images and deploys to heroku using <app_name>, app name defaults to beta-calico
STR
}

HEROKU_APP="beta-calico"
while test $# -gt 0
do
  case $1 in
  --app | -a)
    HEROKU_APP="$2"
    shift
    ;;
  --help | -h | '-?' )
    usage
    exit 0
    ;;
  -*)
    fatal "Unrecognized option: $1"
    usage
    exit 1
    ;;
  *)
    break
    ;;
  esac
  shift
done

eval $(docker-machine env)
docker-compose build web
info "Assuming that you have logged into heroku"
set -x
heroku docker:release --app "$HEROKU_APP"
heroku run --app beta-calico rake --trace db:migrate db:seed
info "Completed deployment"
echo $?
